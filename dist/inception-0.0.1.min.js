/*!
 * inception.js v0.0.1 
 * Copyright 2012, Spider Strategies <nathan.bowser@spiderstrategies.com> 
 * inception.js may be freely distributed under the BSD license. 
*/
(function(e){"use strict";var t=function(e){this.container=e.container;if(!e.container)throw new Error("inception needs a container");_.defaults(e,{topOffset:50,scale:.02,labelField:"name",linkPop:!1,animate:!0}),this.stack=$("<ul>").addClass("inception-stack"),$(this.container).append(this.stack),this.steps=[],this.opts=e};t.prototype.on=e.Events.on,t.prototype.off=e.Events.off,t.prototype.trigger=e.Events.trigger,t.prototype._resize=function(){if(this.length()===1)return;var e=this.top(),t=0;_.each(_.first(this.steps,_.indexOf(this.steps,e)),function(e,n){e.$el.removeClass("inception-step-top");var r=1-this.opts.scale*(this.steps.length-e.index-1),i=-1*((this.opts.topOffset-this.opts.topOffset*r)/2)*(1/r),s="scale("+r+","+r+") translate(0, "+i+"px)";e.$el.height(this.opts.topOffset).css({"-webkit-transform":s,"-moz-transform":s,"-ms-transform":s,"-o-transform":s,transform:s,"margin-top":t+"px",overflow:"hidden"}),t+=this.opts.topOffset*r},this),e.$el.css("margin-top",t+"px"),this.bottom().$el.height(this.opts.topOffset)},t.prototype.top=function(){return _.last(this.steps)},t.prototype.bottom=function(){return _.first(this.steps)},t.prototype.push=function(e,t){var r=this.top(),i=new n({view:e,opts:this.opts,label:e[this.opts.labelField],index:this.steps.length});r&&(r.drop(),i.$el.addClass("inception-step-top")),i.on("close",this._retreat,this),this.stack.append(i.render().el),this.steps.push(i),this._resize()},t.prototype._retreat=function(e){_.each(_.rest(this.steps,_.indexOf(this.steps,e)+1),this.pop,this)},t.prototype.pop=function(){this.steps.pop().destroy(),_.last(this.steps).rise(),this._resize()},t.prototype.length=function(){return this.steps.length};var n=e.View.extend({tagName:"li",className:"inception-step",events:{"click .inception-step-cover":"close"},initialize:function(){this.cover=(new r({label:this.options.label,linkPop:this.options.opts.linkPop})).render(),this.view=this.options.view,this.index=this.options.index,this.topOffset=this.options.opts.topOffset},render:function(){return this.$el.append(this.view.render().el),this},close:function(){this.trigger("close",this)},drop:function(){return this.$el.append(this.cover.el),this},rise:function(){return this.$el.css({height:"","-webkit-transform":"","-moz-transform":"","-ms-transform":"","-o-transform":"",transform:""}),this.cover.remove(),this},destroy:function(){this.cover.remove(),this.remove(),this.cover=null}}),r=e.View.extend({className:"inception-step-cover",initialize:function(){this.linkpop=this.options.linkPop,this.label=this.options.label,this.events={},this.events["click"+(this.linkPop?" a":"")]="close"},close:function(e){e.preventDefault()},render:function(){return this.$el.html('<header><a href="#">'+this.label+"</a></header>"),this}});return e.Inception=t,e})(window.Backbone);